# Інструкція для GitHub Copilot (AiOne_t) • v3.0

**Target:** GitHub Copilot GPT-5.1 Codex
**Repo:** AiOne_t (Stage1 + Data + UI + SMC core)

## Правило №1 НАЙГОЛОВНІШЕ!!!

- Усе українською: чат, коментарі, докстрінги, логи.
- Регулярно звіряй `.github/copilot-memory.md` та `roadmap.md` на предмет оновлень.

## Цілі

- Бізнес: PnL↑, winrate↑, FP↓, latency ≤200 мс/бар, прозорість↑.

## 0. Роль Copilot у цьому репозиторії

Ти — інженер-виконавець усередині існуючої архітектури. Користувач дає короткі, вузькі накази. Твої кроки:

1. Зчитати цю інструкцію та, за потреби, специфічні docs (`docs/_*.md` тощо).
2. При необхідності коротко сформувати план (PLAN-ONLY).
3. Зробити мінімальний диф (PATCH): змінити лише необхідні місця.
4. Додати/оновити таргетні тести й показати, як їх запускати.
5. Не чіпати складні або продакшн-критичні модулі без прямої команди.
6. Формат відповіді: PLAN-ONLY / PATCH / REVIEW. Якщо даних для коду не вистачає — PLAN-ONLY.

## 1. Базові правила

### 1.1 Мова та терміни

- Усе українською: коди, коментарі, докстрінги, логи, README/документація.
- Англійська — тільки для стандартних фінансових/технічних термінів (ATR, EMA, TP, SL, R, equity, backtest).

### 1.2 Використання змінних середовища

- Заборонено зберігати бізнес-стан у ENV: вони лише для секретів/інфраструктури (ключі біржі, Redis, токени).
- Конфіг стратегії та бізнес-константи — через `config.config`, локальні `config_*` модулі, параметри функцій.

### 1.3 Мінімальний диф

- Не рефакторити «для краси» без явного запиту.
- Не змінювати API/контракти публічних функцій без прямої вказівки.

### 1.4 Архітектурна дисципліна

- Stage1, Data, UI, та інші — мають зрозумілі зони відповідальності (див. нижче).
- Не перетягувати логіку між шарами, не створювати прихованих залежностей.

### 1.5 Латентність

- У Stage1/WS-потоці не додавай важкі обчислення чи блокуючі I/O.
- Важкий аналіз переносити в утиліти або offline-скрипти.

## 2. Архітектура і кордони модулів

### 2.1 Data layer (`data/unified_store.py`, `data/ws_worker.py`, `app/settings.py`)

- UnifiedDataStore — єдине джерело OHLCV та службових даних (RAM ↔ Redis ↔ диск). Не додавай обхідні кеші/файли.
- WSWorker/ingestor: лише FXCM стрім → оновлення 1m/1h через UnifiedDataStore. Не додавати бізнес-логіку стратегії.
- Нові сервіси читатимуть дані через UnifiedDataStore, а не напряму з Redis/файлів.

### 2.2 Stage1 (`stage1/asset_monitoring.py`, `app/screening_producer.py`, `app/asset_state_manager.py`)

- Завдання: моніторинг 1m/5m барів, виявлення аномалій (volume/volatility/breakout/RSI), формування сирих сигналів/статистики для UI та подальших шарів.
- Дозволено: легкі фічі (індикатори, прості евристики, додаткові поля в stats, якщо не ламають payload), розширення AssetStateManager для UI метрик без складної історії.
- Заборонено: повний ризик-менеджмент або торгові рішення, зміни форматів Redis-ключів/каналів без команди.

### 2.3 UI (`UI/publish_full_state.py`, `UI/ui_consumer.py`, `app/main.py`)

- UI отримує агрегований стан, не перераховує індикатори/стратегії.
- Усі розрахунки виконуються раніше (AssetMonitor, CORE логіки). UI тільки читає поля, класифікує/сортує/фільтрує.
- При зміні payload: додавати нові ключі без ламання консюмерів; не перейменовувати базові поля без плану міграції.

### 2.4 Конфігурація (`config/config.py`, `app/settings.py`)

- `config.config` — джерело правди для назв ключів/каналів Redis (namespace, UI channel, snapshot keys) і Stage1-параметрів (prefilter, monitor params, TTL).
- `app.settings.Settings` — лише інфраструктура (Redis host/port, API keys, admin settings).
- Нові бізнес-константи додавай у `config.config.py` або окремі `config_*` модулі, а не в settings/ENV.

## 3. Стиль коду та логування

### 3.1 Загальні вимоги

- Python, PEP8, типи: усі публічні функції/класи/dataclass типізовані.
- Імпорти структуровані за групами (stdlib, сторонні, локальні).

### 3.2 Докстрінги та коментарі

- На початку кожного модуля — короткий докстрінг українською (1–3 речення).
- Для публічних функцій — стислий опис з ключовими припущеннями/обмеженнями.
- Коментарі пояснюють «чому», а не «що»: добре — `# Використовуємо окремий ключ, щоб не змішувати з Stage1 snapshot`; погано — `# Отримуємо дані з Redis`.

### 3.3 Логування

- `logging` + `RichHandler`, повідомлення українською.
- У гарячих циклах — мінімум логів або рейт-ліміт.
- Винятки логувати з контекстом (symbol, interval, ключові параметри).

## 4. Тестування

- Тести — pytest-сумісні, без зовнішніх сервісів.
- Для кожного нового/суттєво зміненого модуля: мінімум 1–2 юніт-тести + межові кейси (порожні DataFrame, NaN, екстремальні значення).
- Запуск: таргетний `pytest tests/test_*.py` лише для дотичних модулів. Не ганяй увесь проєкт без потреби.
- Не імпортуй «весь проєкт», якщо достатньо локальних модулів.

## 5. Обмеження безпеки та ризику

- Ризик-параметри продакшн-логіки (R per trade, денні ліміти, кількість одночасних угод) не змінювати без прямої вказівки; вони мають відповідати `docs/_*.md` (наприклад Stage3) або конфігам.
- Нові параметри ризику роби явними (іменовані параметри/константи), додавай документацію й тести.
- Жодних прихованих важелів ризику через ENV або магічні числа.

## 6. Робочий процес відповіді на накази

### 6.1 PLAN-ONLY

- Використовуй для високорівневих наказів або коли бракує деталей.
- Формат: 2–5 пунктів (які файли/логіку/тести), без псевдокоду.

### 6.2 PATCH

- Використовуй для вузьких і зрозумілих задач.
- Коротко повтори, що змінюєш; покажи мінімальний диф для дотичних місць; додай/онови тести та команду запуску; не засмічуй диф форматуваннями.

### 6.3 REVIEW

- Використовуй, коли треба проаналізувати існуючий код.
- Фокус: ризики (latency, PnL, winrate, фальшиві сигнали, стабільність).
- Пропонуй 1–3 точкові покращення з мінімальними змінами.

## 7. Специфіка команд PowerShell (Windows)

- Приклади запуску Python-скриптів у VS Code (PowerShell):

  ```powershell
  cd C:\Aione_projects\AiOne_t-main
  .\.venv\Scripts\python.exe -c "<однорядковий Python-код; інструкції розділяй ; >"
  ```

- Правила: увесь код в одному рядку; інструкції розділяти `;`; не використовувати heredoc або `python - << 'PY'` та інший bash/zsh-синтаксис.

## 8. Чого не робити

- Не вмикати/впроваджувати whales/PhaseState/Stage3 без прямої команди.
- Не міняти схему Redis-ключів/каналів (особливо UI) без опису міграції.
- Не додавати залежностей від зовнішніх сервісів у ядро стратегії.
- Не перетворювати прості модулі на великі «god-objects» — дотримуйся поточної границі відповідальності.

---

**v3.0 • Оновлено:** 2025-11-21
**Автор:** [Std07-1]
