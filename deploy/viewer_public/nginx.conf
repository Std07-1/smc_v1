limit_req_zone $binary_remote_addr zone=api_rl:10m rate=10r/s;

server {
    listen 80;
    server_name _;

    location = / {
        proxy_pass http://host.docker.internal:8080;
        proxy_set_header Host $host;
    }

    location ~* \.(js|css|ico|png|svg|map|woff2?)$ {
        proxy_pass http://host.docker.internal:8080;
        proxy_set_header Host $host;
    }

    location = /smc-viewer/snapshot {
        limit_req zone=api_rl burst=20 nodelay;
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_pass http://host.docker.internal:8080;
        proxy_set_header Host $host;
    }

    location = /smc-viewer/ohlcv {
        limit_req zone=api_rl burst=20 nodelay;
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_pass http://host.docker.internal:8080;
        proxy_set_header Host $host;
    }

    location /smc-viewer/stream {
        proxy_pass http://host.docker.internal:8081;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # FXCM live (OHLCV/ticks) у same-origin.
    # Це дає “живу” свічку (complete=false) і live-volume у браузері, якщо:
    # - на хості запущений FXCM WS міст
    # - FXCM_OHLCV_WS_ENABLED=1
    # - FXCM_OHLCV_WS_HOST=0.0.0.0 (щоб контейнер nginx міг під'єднатися)
    # На фронті відкрий: ?fxcm_ws=1&fxcm_ws_same_origin=1
    location /fxcm/ {
        proxy_pass http://host.docker.internal:8082;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_buffering off;
    }

    location / { return 404; }
}
