limit_req_zone $binary_remote_addr zone=api_rl:10m rate=10r/s;

server {
    listen 80;
    server_name aione-smc.com www.aione-smc.com;

    location = / {
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;
        proxy_pass http://host.docker.internal:8080;
        proxy_set_header Host $host;
    }

    location ~* \.(js|css|ico|png|svg|map|woff2?)$ {
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;
        proxy_no_cache 1;
        proxy_cache_bypass 1;
        proxy_pass http://host.docker.internal:8080;
        proxy_set_header Host $host;
    }

    location = /smc-viewer/snapshot {
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;
        limit_req zone=api_rl burst=20 nodelay;
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_pass http://host.docker.internal:8080;
        proxy_set_header Host $host;
    }

    location = /smc-viewer/ohlcv {
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;
        limit_req zone=api_rl burst=20 nodelay;
        proxy_hide_header Access-Control-Allow-Origin;
        proxy_pass http://host.docker.internal:8080;
        proxy_set_header Host $host;
    }

    location /smc-viewer/stream {
        proxy_pass http://host.docker.internal:8081;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_buffering off;
    }

    # FXCM live (OHLCV/ticks) у same-origin.
    # Це дає “живу” свічку (complete=false) і live-volume у браузері, якщо:
    # - на хості запущений FXCM WS міст
    # - FXCM_OHLCV_WS_ENABLED=1
    # - FXCM_OHLCV_WS_HOST=0.0.0.0 (щоб контейнер nginx міг під'єднатися)
    # На прод-домені (aione-smc.com) фронт за замовчуванням піднімає FXCM live через same-origin.
    # Ручне вимкнення: додай у URL `fxcm_ws=0`.
    location /fxcm/ {
        proxy_pass http://host.docker.internal:8082;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_buffering off;
    }

    location = /index.html {
        add_header Cache-Control "no-store" always;
        add_header Pragma "no-cache" always;
        proxy_pass http://host.docker.internal:8080;
        proxy_set_header Host $host;
    }

    location / { return 404; }
}
