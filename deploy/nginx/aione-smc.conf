# Nginx reverse-proxy для same-origin SMC UI.
#
# Ціль:
# - https://www.aione-smc.com/            -> HTTP UI_v2 (8080)
# - wss://www.aione-smc.com/smc-viewer/stream -> WS viewer_state (8081)
#
# Примітка:
# - SSL термінація очікується на рівні Cloudflare (Tunnel або проксійований DNS).
# - Цей конфіг слухає 80/tcp (origin).
# - Для “як TradingView” важливо, щоб HTTP і WS були на одному origin.

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 80;
    server_name aione-smc.com www.aione-smc.com;

    # --- HTTP (статичний UI + REST) ---
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 60s;
    }

    # --- WS (viewer_state live stream) ---
    # Очікуваний клієнтський URL:
    # wss://www.aione-smc.com/smc-viewer/stream?symbol=XAUUSD
    location /smc-viewer/stream {
        proxy_pass http://127.0.0.1:8081;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
        proxy_buffering off;
    }

    # --- (опційно) FXCM live у same-origin ---
    # Увімкнути, якщо ви реально хочете live-свічки через WS міст на 8082.
    # На фронті: ?fxcm_ws=1&fxcm_ws_same_origin=1
    #
    # location /fxcm/ {
    #     proxy_pass http://127.0.0.1:8082;
    #     proxy_http_version 1.1;
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection $connection_upgrade;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_read_timeout 3600s;
    #     proxy_send_timeout 3600s;
    #     proxy_buffering off;
    # }
}
