# Профілі local/prod та узгодження з FXCM-конектором

Цей документ пояснює, як ізолювати локальний запуск цього репо від прод-Redis і прод-каналів FXCM-конектора.

## 1) Один перемикач профілю

У корені репо файл `.env` використовується як **dispatcher** і має містити тільки прості рядки, без коментарів в кінці рядка, без ключів/сертифікатів.

- Локально:
  - `AI_ONE_ENV_FILE=.env.local`
- На сервері:
  - `AI_ONE_ENV_FILE=.env.prod`

Сам профіль (local/prod) задається всередині відповідного файлу через `AI_ONE_MODE`.

## 2) Ізоляція Redis namespace (щоб локалка не чіпала прод)

- У цьому репо всі UI ключі/канали в Redis будуються від `NAMESPACE` (SSOT у `config/config.py`).
- `NAMESPACE` береться так:
  - якщо задано `AI_ONE_NAMESPACE` → він має пріоритет
  - інакше визначається з `AI_ONE_MODE`:
    - `local` → `ai_one_local`
    - `prod` → `ai_one`

Рекомендація:

- у `.env.local` завжди тримати `AI_ONE_NAMESPACE=ai_one_local` (для додаткової страховки).

## 3) Ізоляція каналів FXCM-конектора (щоб локалка не слухала/писала prod)

Цей репо **не підключається до FXCM напряму**. Він читає OHLCV/price/status з Redis Pub/Sub, які публікує окремий FXCM-конектор.

Канали FXCM задаються через префікс:

- `FXCM_CHANNEL_PREFIX=fxcm` (prod)
- `FXCM_CHANNEL_PREFIX=fxcm_local` (local)

З цього префікса формуються канали:

- OHLCV: `{prefix}:ohlcv`
- price tick: `{prefix}:price_tik`
- status: `{prefix}:status`
- commands: `{prefix}:commands`

Отже, щоб локальний запуск не чіпав прод-конектор:

- у `.env.local` ставимо `FXCM_CHANNEL_PREFIX=fxcm_local`
- FXCM-конектор локально теж має публікувати в `fxcm_local:*`

## 4) Що треба налаштувати у FXCM-конекторі (сценарій A: локальний конектор)

У репо конектора має бути узгоджено:

- Pub/Sub publish:
  - OHLCV → `fxcm_local:ohlcv`
  - price tick → `fxcm_local:price_tik`
  - status → `fxcm_local:status`
- Pub/Sub subscribe:
  - commands → `fxcm_local:commands`

Якщо конектор має власні `ENV`, зазвичай достатньо одного параметра на його стороні:

- `FXCM_CHANNEL_PREFIX=fxcm_local`

Або еквівалентні явні назви каналів (якщо у конекторі немає префікса).

## 5) Про порти і «колізії»

- Порти (`8080/8081/8082`) — це локальні TCP порти для UI/WS.
- Ризик «перемалювання/стирання історії» був не через порти, а через **спільні Redis ключі/канали**.
- Якщо локальний запуск на вашому ПК, а прод — на VPS, то порти не конфліктують фізично.
- Якщо ж запускати local і prod на одному хості одночасно, тоді порти повинні відрізнятися.

## 6) Важливе про `.env` і PEM/сертифікати

Не кладіть PEM-блоки та багаторядкові сертифікати в `.env`/`.env.local`/`.env.prod`.

Правильно:

- зберігати сертифікат у файлі
- в ENV зберігати тільки шлях: наприклад `CF_TUNNEL_CERT_PATH=...`

Це зменшує ризик падінь парсингу dotenv і випадкових конфіг-«артефактів».
